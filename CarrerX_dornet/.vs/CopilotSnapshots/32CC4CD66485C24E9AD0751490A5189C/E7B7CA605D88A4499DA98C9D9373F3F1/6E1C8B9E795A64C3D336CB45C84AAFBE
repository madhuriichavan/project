using CareerX_dotnet.Model;
using QuestPDF.Fluent;
using QuestPDF.Helpers;
using QuestPDF.Infrastructure;
using System.Text.Json;

namespace CareerX_dotnet.Services;

public class PdfService
{
    public PdfService()
    {
        QuestPDF.Settings.License = LicenseType.Community;
    }

    public Task<byte[]> GenerateAssessmentReportPdf(StudentAssessment assessment, List<McqQuestion>? questions, List<int> answers, string recommendationJson)
    {
        var recommendation = string.IsNullOrEmpty(recommendationJson) 
            ? null 
            : JsonSerializer.Deserialize<JsonElement>(recommendationJson);

        var document = Document.Create(container =>
        {
            container.Page(page =>
            {
                page.Size(PageSizes.A4);
                page.Margin(2, Unit.Centimetre);
                page.PageColor(Colors.White);
                page.DefaultTextStyle(x => x.FontSize(10));

                page.Header()
                    .Text("Career Assessment Report")
                    .SemiBold().FontSize(20).FontColor(Colors.Blue.Medium);

                page.Content()
                    .PaddingVertical(1, Unit.Centimetre)
                    .Column(column =>
                    {
                        column.Spacing(20);

                        // Score Section
                        column.Item().Text($"Overall Score: {assessment.Score:F2}%")
                            .SemiBold().FontSize(16);

                        column.Item().Text($"Assessment Date: {assessment.CompletedAt:dd MMM yyyy}")
                            .FontSize(12).FontColor(Colors.Grey.Darken1);

                        // Recommendation Section
                        if (recommendation.HasValue)
                        {
                            column.Item().Text("Career Recommendations")
                                .SemiBold().FontSize(14).PaddingTop(10);

                            if (recommendation.Value.TryGetProperty("recommendedCareer", out var career))
                            {
                                column.Item().Text($"Recommended Career: {career.GetString()}")
                                    .FontSize(12);
                            }

                            if (recommendation.Value.TryGetProperty("skillScore", out var skillScore))
                            {
                                column.Item().Text($"Skill Score: {skillScore.GetInt32()}/100")
                                    .FontSize(12);
                            }

                            if (recommendation.Value.TryGetProperty("strengths", out var strengths))
                            {
                                column.Item().Text("Strengths:")
                                    .SemiBold().FontSize(12).PaddingTop(5);
                                
                                if (strengths.ValueKind == JsonValueKind.Array)
                                {
                                    foreach (var strength in strengths.EnumerateArray())
                                    {
                                        column.Item().Text($"• {strength.GetString()}")
                                            .FontSize(11).PaddingLeft(10);
                                    }
                                }
                                else
                                {
                                    column.Item().Text($"• {strengths.GetString()}")
                                        .FontSize(11).PaddingLeft(10);
                                }
                            }

                            if (recommendation.Value.TryGetProperty("weaknesses", out var weaknesses))
                            {
                                column.Item().Text("Areas for Improvement:")
                                    .SemiBold().FontSize(12).PaddingTop(5);
                                
                                if (weaknesses.ValueKind == JsonValueKind.Array)
                                {
                                    foreach (var weakness in weaknesses.EnumerateArray())
                                    {
                                        column.Item().Text($"• {weakness.GetString()}")
                                            .FontSize(11).PaddingLeft(10);
                                    }
                                }
                                else
                                {
                                    column.Item().Text($"• {weaknesses.GetString()}")
                                        .FontSize(11).PaddingLeft(10);
                                }
                            }
                        }

                        // Summary
                        column.Item().Text("Next Steps")
                            .SemiBold().FontSize(14).PaddingTop(10);

                        column.Item().Text("Based on your assessment results, we recommend:")
                            .FontSize(12);

                        column.Item().Text("1. Review the recommended career paths")
                            .FontSize(11).PaddingLeft(10);
                        column.Item().Text("2. Focus on improving identified areas")
                            .FontSize(11).PaddingLeft(10);
                        column.Item().Text("3. Consider subscribing to our career-path roadmap service")
                            .FontSize(11).PaddingLeft(10);
                        column.Item().Text("4. Complete your profile for personalized guidance")
                            .FontSize(11).PaddingLeft(10);
                    });

                page.Footer()
                    .AlignCenter()
                    .Text(x =>
                    {
                        x.Span("CareerX - Your Career Guidance Partner");
                        x.Span(" | Page ");
                        x.CurrentPageNumber();
                    })
                    .FontSize(9).FontColor(Colors.Grey.Medium);
            });
        });

        return Task.FromResult(document.GeneratePdf());
    }
}

